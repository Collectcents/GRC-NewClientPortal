@model GRC_NewClientPortal.Models.ChangePasswordModel
@{
    Layout = null; // or "_Layout" if you have one
    ViewData["Title"] = "General Revenue Corporation :: Clients Access, Home";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>@ViewData["Title"]</title>
	<link rel="stylesheet" href="/css/style.css?v=@DateTime.Now.Ticks" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">


    <script type="text/javascript">
        // Image preload/swap functions (optional if used in legacy UI)
        function MM_swapImgRestore() {
            var i, x, a = document.MM_sr;
            for (i = 0; a && i < a.length && (x = a[i]) && x.oSrc; i++)
                x.src = x.oSrc;
        }

        function MM_preloadImages() {
            var d = document;
            if (d.images) {
                if (!d.MM_p) d.MM_p = [];
                var i, j = d.MM_p.length, a = MM_preloadImages.arguments;
                for (i = 0; i < a.length; i++)
                    if (a[i].indexOf("#") != 0) {
                        d.MM_p[j] = new Image;
                        d.MM_p[j++].src = a[i];
                    }
            }
        }

        function MM_findObj(n, d) {
            var p, i, x;
            if (!d) d = document;
            if ((p = n.indexOf("?")) > 0 && parent.frames.length) {
                d = parent.frames[n.substring(p + 1)].document;
                n = n.substring(0, p);
            }
            if (!(x = d[n]) && d.getElementById)
                x = d.getElementById(n);
            return x;
        }

        function MM_swapImage() {
            var i, j = 0, x, a = MM_swapImage.arguments;
            document.MM_sr = [];
            for (i = 0; i < (a.length - 2); i += 3)
                if ((x = MM_findObj(a[i])) != null) {
                    document.MM_sr[j++] = x;
                    if (!x.oSrc) x.oSrc = x.src;
                    x.src = a[i + 2];
                }
        }

        $(document).ready(function () {
            // Modern equivalent of Web.config AppSettings access
            const accessDeniedMsg = '@ViewBag.RoleAccessDeniedMsg';


            const mapping = [
                { link: '#hlnkAccounts', div: '#dvAccounts' },
                { link: '#hlnkReports', div: '#dvReports' },
                { link: '#hlnkPlacements', div: '#dvPlacements' },
                { link: '#hlnkAchs', div: '#dvAchs' },
                { link: '#hlnMyRefGuide', div: '#dvMyRefGuide' },
                { link: '#hlnValMedia', div: '#dvValMedia' }
            ];

            mapping.forEach(item => {
                if ($(item.link).hasClass('disableButton')) {
                    $(item.div).attr('title', accessDeniedMsg);
                }
            });
        });
    </script>
</head>
	<body>

		<div class="auth-page-content">
	<div class="top-bar">
		<div class="top-links">
				<a asp-controller="Home" asp-action="Index">Home</a>
			<a href="search.htm">Search</a>
			<a href="contact.aspx">Contact Us</a>
		</div>
	</div>

	<header class="main-header">
		<div class="header-left">
			<a href="FW/menu.aspx">
				<img src="/images/home/logo_home2.png" alt="Home" height="60">
			</a>
		</div>

	</header>
		<section class="auth-page-section">
			<div class="auth-form-card">

				<h2 class="auth-form-title">Change Password</h2>

        @if (ViewBag.Message != null)
        {
            <div class="alert alert-warning text-center fw-semibold">
                @Html.Raw(ViewBag.Message)
            </div>
        }

        <!-- Collapsible Instructions -->
        <div class="instruction-wrapper">
            <button type="button"
                    class="instruction-toggle"
                    onclick="toggleInstructions()">
                Password Rules
                <span id="instructionIcon">+</span>
            </button>

            <div id="instructionPanel" class="instruction-card">
                <ul>
                    <li>No three or more repetitive characters (aaa, bbb)</li>
                    <li>Minimum 8 characters</li>
                    <li>Must include at least <strong>3</strong> of the following:
                    <ul>
								<li>Special characters(!, &#64; , #, $, %)</li>
                        <li>Lowercase letter</li>
                        <li>Uppercase letter</li>
                        <li>Number</li>
                    </ul>
					</li>

                    <li>No dictionary words or proper names</li>
                    <li>Must not contain first or last name</li>
                    <li>Passwords are case sensitive</li>
                </ul>
            </div>
        </div>

				<div id="message" class="text-center fw-semibold mb-2 text-danger"></div>


		<form id="changePasswordForm" onsubmit="updatePassword(); return false;">
    @Html.AntiForgeryToken()
        <!-- Old Password -->
				<div class="auth-form-field">
					<label>Old Password</label>

					<div class="password-input-wrapper">
							<input type="password" id="OldPassword" name="OldPassword" autocomplete="off" />

						<button type="button"
								class="password-toggle"
								onmousedown="showPassword('OldPassword', this)"
								onmouseup="hidePassword('OldPassword', this)"
								onmouseleave="hidePassword('OldPassword', this)"
								ontouchstart="showPassword('OldPassword', this)"
								ontouchend="hidePassword('OldPassword', this)">
							<i class="bi bi-eye"></i>
						</button>
					</div>
				</div>

        <!-- New Password -->
				<div class="auth-form-field">
            <label>New Password</label>
					<div class="password-input-wrapper">
							<input type="password" id="NewPassword" name="NewPassword" autocomplete="off" />

						<button type="button"
								class="password-toggle"
								onmousedown="showPassword('NewPassword', this)"
								onmouseup="hidePassword('NewPassword', this)"
								onmouseleave="hidePassword('NewPassword', this)"
								ontouchstart="showPassword('NewPassword', this)"
								ontouchend="hidePassword('NewPassword', this)">
							<i class="bi bi-eye"></i>
						</button>
					</div>
						
        </div>

        <!-- Confirm Password -->
				<div class="auth-form-field">
            <label>Confirm New Password</label>
					<div class="password-input-wrapper">
							<input type="password" id="ConfirmPassword" name="ConfirmPassword" autocomplete="off" />

						<button type="button"
								class="password-toggle"
								onmousedown="showPassword('ConfirmPassword', this)"
								onmouseup="hidePassword('ConfirmPassword', this)"
								onmouseleave="hidePassword('ConfirmPassword', this)"
								ontouchstart="showPassword('ConfirmPassword', this)"
								ontouchend="hidePassword('ConfirmPassword', this)">
							<i class="bi bi-eye"></i>
						</button>
					</div>
        </div>

        <div class="button-group">
            
						<button type="submit" class="btn-common btn-primary-common">Update</button>
						<button type="button"  class="btn-common btn-secondary-common" id="btnClear" onclick="clearPasswordFields()">Clear All</button>
        </div>
				</form>
    </div>
</section>


	</div>
	<!-- FOOTER -->
	<footer class="site-footer">
		<div class="footer-links">
			<a href="FW/menu.aspx">Home</a> |
			<a href="contact.aspx">Contact Us</a> |
			<a href="Terms%20and%20conditions.htm">Terms & Conditions</a>
		</div>

		<div class="footer-copy">
			General Revenue Corporation • 4660 Duke Drive, Suite 200 • Mason, OH 45040-8466<br>
			© Copyright @DateTime.Now.Year — All rights reserved.<br>
			<a href="privacy.htm">Privacy Notice</a>
		</div>
	</footer>
	
		@* <table  style="height:300" width="100%" cellspacing="0" cellpadding="0" border="0">
									<tr>
										<td colspan="2">
										@{
											bool passwordChanged = ViewBag.PasswordChanged ?? false;
											string accessDeniedMsg = ViewBag.RoleAccessDeniedMsg ?? "Access Denied";
										}

										<div class="dvmenu">

											<!-- Accounts -->
											@{
												bool hasAccessAccounts = ViewBag.CanAccessAccounts ?? false;
												bool isEnabledAccounts = passwordChanged && hasAccessAccounts;
												string tooltipAccounts = !passwordChanged ? "Change password to enable menu" :
												!hasAccessAccounts ? accessDeniedMsg : "";
											}
											<div id="dvAccounts" class="dvAccounts">
												@if (isEnabledAccounts)
												{
													<a asp-controller="FW" asp-action="MasterSearch" class="enableButton" title="@tooltipAccounts">
														<img src="~/images/about/MYACCOUNTSsm.gif" height="18" alt="Accounts" />
													</a>
												}
												else
												{
													<a class="disableButton" title="@tooltipAccounts">
														<img src="~/images/about/MYACCOUNTSsm.gif" height="18" alt="Accounts" />
													</a>
												}
											</div>

											<!-- ACHs -->
											@{
												bool hasAccessAchs = ViewBag.CanAccessACH ?? false;
												bool isEnabledAchs = passwordChanged && hasAccessAchs;
												string tooltipAchs = !passwordChanged ? "Change password to enable menu" :
												!hasAccessAchs ? accessDeniedMsg : "";
											}
											<div id="dvAchs">
												@if (isEnabledAchs)
												{
													<a asp-controller="FW" asp-action="ClientsAch" class="enableButton" title="@tooltipAchs">
														<img src="~/images/about/MYACHSsm.gif" height="18" alt="ACHs" />
													</a>
												}
												else
												{
													<a class="disableButton" title="@tooltipAchs">
														<img src="~/images/about/MYACHSsm.gif" height="18" alt="ACHs" />
													</a>
												}
											</div>

											<!-- Placements -->
											@{
												bool hasAccessPlacements = ViewBag.CanAccessPlacements ?? false;
												bool isEnabledPlacements = passwordChanged && hasAccessPlacements;
												string tooltipPlacements = !passwordChanged ? "Change password to enable menu" :
												!hasAccessPlacements ? accessDeniedMsg : "";
											}
											<div id="dvPlacements">
												@if (isEnabledPlacements)
												{
													<a asp-controller="FW" asp-action="ClientsCollegesAccount" class="enableButton" title="@tooltipPlacements">
														<img src="~/images/about/MYPLACEMENTSsm.gif" height="18" alt="Placements" />
													</a>
												}
												else
												{
													<a class="disableButton" title="@tooltipPlacements">
														<img src="~/images/about/MYPLACEMENTSsm.gif" height="18" alt="Placements" />
													</a>
												}
											</div>

											<!-- My Reference Guide (always enabled) -->
											<div id="dvMyRefGuide">
												<a asp-controller="FW" asp-action="ClientCal" class="enableButton">
													<img src="~/images/about/MyRefGuide.gif" height="18" alt="My Reference Guide" />
												</a>
											</div>

											<!-- Reports -->
											@{
												bool hasAccessReports = ViewBag.CanAccessReports ?? false;
												bool isEnabledReports = passwordChanged && hasAccessReports;
												string tooltipReports = !passwordChanged ? "Change password to enable menu" :
												!hasAccessReports ? accessDeniedMsg : "";
											}
											<div id="dvReports">
												@if (isEnabledReports)
												{
													<a asp-controller="FW" asp-action="MasterReports" class="enableButton" title="@tooltipReports">
														<img src="~/images/about/MYREPORTSsm.gif" height="18" alt="Reports" />
													</a>
												}
												else
												{
													<a class="disableButton" title="@tooltipReports">
														<img src="~/images/about/MYREPORTSsm.gif" height="18" alt="Reports" />
													</a>
												}
											</div>

											<!-- Validation Media -->
											@{
												bool hasAccessValMedia = ViewBag.CanAccessValidMedia ?? false;
												bool isEnabledValMedia = passwordChanged && hasAccessValMedia;
												string tooltipValMedia = !passwordChanged ? "Change password to enable menu" :
												!hasAccessValMedia ? accessDeniedMsg : "";
											}
											<div id="dvValMedia">
												@if (isEnabledValMedia)
												{
													<a asp-controller="FW" asp-action="ValidationDebtMedia" class="enableButton" title="@tooltipValMedia">
														<img src="~/images/about/MyValMedia.gif" height="18" alt="Validation Media" />
													</a>
												}
												else
												{
													<a class="disableButton" title="@tooltipValMedia">
														<img src="~/images/about/MyValMedia.gif" height="18" alt="Validation Media" />
													</a>
												}
											</div>

										
															<ul>
                                                                <li>Password should not contain three or more repetitive characters (&#034;aaa,&#034; &#034;bbb&#034;).</li>
                                                                <li>Password must be at least eight characters.</li>
																<li>Password must contain some combination of at least three of the following:
                                                                    <ul>
                                                                    <li>Special characters any of !, &#64; , #, $, %</li>
                                                                    <li>Should contain one lowercase character.</li>
                                                                    <li>Should contain one uppercase character.</li>
                                                                    <li>Should contain one numeric.</li>
                                                                    </ul>
                                                                </li>
                                                                <li>Password should not contain words found in the dictionary or proper names.</li>
                                                                <li>Password should not contain your first name or last name.</li>
                                                                <li>Passwords are case sensitive.</li>
															</ul>
														</asp:panel>
														<p>

														@* <div id="message" style="color:red;"></div>
														@if (ViewBag.Message != null)
														{
															<div class="alert alert-warning text-center fw-semibold" role="alert">
																@Html.Raw(ViewBag.Message)
															</div>
														}

														<asp:panel id="Panel1" runat="server" ClientIDMode="Static">
														<div class="container py-5">
															<div class="row justify-content-center">
																<div class="col-md-6">

																	<div class="card shadow-sm border-0">
																		<div class="card-body">

																			<!-- Validation Summary -->
																			<div asp-validation-summary="All" class="text-danger text-center mb-3"></div>
																			@if (ViewBag.Message != null)
																			{
																				<div class="alert alert-warning text-center fw-semibold" role="alert">
																					@Html.Raw(ViewBag.Message)
																				</div>
																			}

																			<!-- Old Password -->
																			<div class="mb-3 position-relative">
																				<label asp-for="OldPassword" class="form-label">Old Password</label>
																				<div class="input-group">
																					<input asp-for="OldPassword" id="OldPassword" class="form-control" type="password" autocomplete="off" />
																					<button type="button" class="btn btn-outline-secondary"
																							onmousedown="showPassword('OldPassword', this)"
																							onmouseup="hidePassword('OldPassword', this)"
																							onmouseleave="hidePassword('OldPassword', this)"
																							ontouchstart="showPassword('OldPassword', this)"
																							ontouchend="hidePassword('OldPassword', this)">
																						<i class="bi bi-eye"></i>
																					</button>
																				</div>
																				<span asp-validation-for="OldPassword" class="text-danger small"></span>
																			</div>

																			<!-- New Password -->
																			<div class="mb-3 position-relative">
																				<label asp-for="NewPassword" class="form-label">New Password</label>
																				<div class="input-group">
																					<input asp-for="NewPassword" id="NewPassword" class="form-control" type="password" autocomplete="off" />
																					<button type="button" class="btn btn-outline-secondary"
																							onmousedown="showPassword('NewPassword', this)"
																							onmouseup="hidePassword('NewPassword', this)"
																							onmouseleave="hidePassword('NewPassword', this)"
																							ontouchstart="showPassword('NewPassword', this)"
																							ontouchend="hidePassword('NewPassword', this)">
																						<i class="bi bi-eye"></i>
																					</button>
																				</div>
																				<span asp-validation-for="NewPassword" class="text-danger small"></span>
																			</div>

																			<!-- Confirm Password -->
																			<div class="mb-3 position-relative">
																				<label asp-for="ConfirmPassword" class="form-label">Confirm New Password</label>
																				<div class="input-group">
																					<input asp-for="ConfirmPassword" id="ConfirmPassword" class="form-control" type="password" autocomplete="off" />
																					<button type="button" class="btn btn-outline-secondary"
																							onmousedown="showPassword('ConfirmPassword', this)"
																							onmouseup="hidePassword('ConfirmPassword', this)"
																							onmouseleave="hidePassword('ConfirmPassword', this)"
																							ontouchstart="showPassword('ConfirmPassword', this)"
																							ontouchend="hidePassword('ConfirmPassword', this)">
																						<i class="bi bi-eye"></i>
																					</button>
																				</div>
																				<span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
																			</div>

																			<!-- Buttons -->
																			<div class="d-flex justify-content-center mt-4">
																				<button type="button" class="btn btn-primary me-3 px-4" onclick="updatePassword()">Update</button>
																				<button type="button" id="btnClear" class="btn btn-secondary px-4" onclick="clearPasswordFields()">Clear All</button>
																			</div>
																		</div>
																	</div>

																</div>
															</div>
														</div>
															</asp:panel>

														<p></p>
														<p>&nbsp;</p> *@
													
													
		<!-- SiteCatalyst code version: H.20.3.
		Copyright 1997-2009 Omniture, Inc. More info available at
		http://www.omniture.com -->
		<script language="JavaScript" type="text/javascript" src="~/js/s_code.js"></script>
		<script language="JavaScript" type="text/javascript"><!--
		/* You may give each page an identifying name, server, and channel on
		the next lines. */

		s.pageName=""
		s.server=""
		s.channel="GRC"
		s.pageType=""
		s.prop1=""
		s.prop2=""
		s.prop3=""
		s.prop4=""
		s.prop5=""
		/* Conversion Variables */
		s.campaign=""
		s.state=""
		s.zip=""
		s.events=""
		s.products=""
		s.purchaseID=""
		s.eVar1=""
		s.eVar2=""
		s.eVar3=""
		s.eVar4=""
		s.eVar5=""
		/************* DO NOT ALTER ANYTHING BELOW THIS LINE ! **************/
		var s_code=s.t();if(s_code)document.write(s_code)//--></script>
		<!--/DO NOT REMOVE/-->
		<!-- End SiteCatalyst code version: H.20.3. -->
		<!-- Google Analytics -->
		<script type="text/javascript">
		var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
		document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		</script>
		<script type="text/javascript">
					try 
					{
						var pageTracker = _gat._getTracker("UA-6408068-1");
						pageTracker._trackPageview();
					}
					catch(err) 
					{
					}
		</script>
		<!-- InstanceEnd -->

	<script>
		function updatePassword() {
			console.log("Inside UpdatePassword function");
			const OldPassword = document.getElementById("OldPassword").value;
			const NewPassword = document.getElementById("NewPassword").value;
			const ConfirmPassword = document.getElementById("ConfirmPassword").value;
				const messageDiv = document.getElementById("message");

		messageDiv.innerHTML = "";

			// basic validation
			if (!OldPassword || !NewPassword || !ConfirmPassword) {
				 messageDiv.innerText = "All fields are required.";
				return;
			}

			if (NewPassword !== ConfirmPassword) {
				messageDiv.innerText = "New password and confirmation do not match!";
				return;
			}

			// Send to controller via fetch API
			fetch('/Login/UpdatePassword', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
				},
				body: JSON.stringify({
					OldPassword: OldPassword,
					NewPassword: NewPassword,
					ConfirmPassword: ConfirmPassword
				})
			})
					.then(response => response.json())
			.then(data => {
				if (data.success) {
					messageDiv.style.color = "green";
					messageDiv.innerText = data.message;

			// 		 document.getElementById("Panel1").style.display = "none";
			// document.getElementById("Panel2").style.display = "none";
			clearPasswordFields();

					// ✅ Reload after short delay to re-enable menus
			setTimeout(() => {
				window.location.reload();
			}, 2000);

				} else {
					messageDiv.style.color = "red";
					if (data.errors && data.errors.length > 0) {
						messageDiv.innerHTML = data.errors.join("<br>");
					} else {
						messageDiv.innerText = data.message || "Password update failed.";
					}
				}
			})
			.catch(error => {
				console.error('Error:', error);
				messageDiv.style.color = "red";
				messageDiv.innerText = "An error occurred while updating password.";
			});
		}

				
		function showPassword(fieldId, btn) {
			const input = document.getElementById(fieldId);
			const icon = btn.querySelector('i');
			input.type = "text";
			icon.classList.remove("bi-eye");
			icon.classList.add("bi-eye-slash");
		}

		function hidePassword(fieldId, btn) {
			const input = document.getElementById(fieldId);
			const icon = btn.querySelector('i');
			input.type = "password";
			icon.classList.remove("bi-eye-slash");
			icon.classList.add("bi-eye");
		}

		function clearPasswordFields() {
			// Clear input values
			document.getElementById("OldPassword").value = "";
			document.getElementById("NewPassword").value = "";
			document.getElementById("ConfirmPassword").value = "";

			// Reset password types (in case eye was pressed)
			document.getElementById("OldPassword").type = "password";
			document.getElementById("NewPassword").type = "password";
			document.getElementById("ConfirmPassword").type = "password";

			// Clear any validation error text
			document.querySelectorAll("span.field-validation-error").forEach(span => {
				span.textContent = "";
			});

			// Clear validation summary if you use asp-validation-summary
			document.querySelectorAll("[asp-validation-summary]").forEach(summary => {
				summary.innerHTML = "";
			});

			// Clear any custom message (like #message)
			const messageDiv = document.getElementById("message");
			if (messageDiv) messageDiv.innerHTML = "";

			// Optionally reset eye icons
			document.querySelectorAll(".bi-eye-slash").forEach(icon => {
				icon.classList.remove("bi-eye-slash");
				icon.classList.add("bi-eye");
			});
		}

			function toggleInstructions() {
			const panel = document.getElementById("instructionPanel");
			const icon = document.getElementById("instructionIcon");

			const isOpen = panel.style.display === "block";
			panel.style.display = isOpen ? "none" : "block";
			icon.innerText = isOpen ? "+" : "−";
		}

	</script>

	</body>
</html>
